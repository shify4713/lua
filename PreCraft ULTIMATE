local component = require("component")
local fs = require("filesystem")
local shell = require("shell")
local event = require("event")
local unicode = require("unicode")
local term = require("term")
local g = component.gpu
local me = component.me_interface

if not fs.exists("/lib/oc.lua") then
    shell.execute("wget https://www.dropbox.com/s/cgfytt8g174a6vs/libPrecraft.lua?dl=1 /lib/oc.lua")
end
local oc = require("oc")

if not fs.exists("/home/BD.txt") then
    oc.savef("BD.txt", {})
end

--------------------Настройки--------------------
local CBUTTON, CDRAW, CTEXT = 0x00ffff, 0x004575, 0xD38FFE
local debug = true
local ADM = {['LiwMorgan']=true}
local scroll, posSelect, maxscroll = 1, 1, 1
local precraft, go = true, true
local WIDTH, HEIGHT = 160, 50
local inputFind = ""
local guiPath, debugLog1, debugLog2 = {}, {}, {}
g.setResolution(WIDTH,HEIGHT)
g.setForeground(CTEXT)
local dataItems, content, yTouch
------------------------------------------------

-- ЛОГИ
local function AddLogs(nameTable, log)
    if nameTable == "ore" then
        if #debugLog1 > 19 then table.remove(debugLog1, 1) end
        table.insert(debugLog1, log)
    else
        if #debugLog2 > 19 then table.remove(debugLog2, 1) end
        table.insert(debugLog2, log)
    end
    Main()
end

-- ВИЗУАЛ
local function Clear() g.setBackground(0x000000) g.setForeground(CTEXT) g.fill(1,4,WIDTH,HEIGHT-4," ") end

local function DrawScrollContent()
    if guiPath[#guiPath] == "start" or guiPath[#guiPath] == "stop" or guiPath[#guiPath] == "go" then
        for i = scroll, math.min(scroll + 34, #content) do
            local k = i - scroll
            if content[i] then
                if i == posSelect then
                    g.setBackground(0x1e1e1e)
                    g.fill(11, 7 + k, 58, 1, " ")
                    g.set(13,7 + k, tostring(i.. ". "..content[i].name))
                    g.set(45,7 + k, tostring(content[i].count))
                    g.set(60,7 + k, tostring(content[i].craftSize))
                    g.setBackground(0x000000)
                else
                    g.setBackground(0x000000)
                    g.fill(11, 7 + k, 58, 1, " ")
                    g.set(13,7 + k, tostring(i.. ". "..content[i].name))
                    g.set(45,7 + k, tostring(content[i].count))
                    g.set(60,7 + k, tostring(content[i].craftSize))
                end
            end
        end
    end
end

local function ScrollContent()
    local cont = {}
    if inputFind ~= nil and inputFind ~= "" then
        for _, data in ipairs(dataItems) do
            if unicode.lower(data.name):find(unicode.lower(inputFind)) then
                table.insert(cont, data)
            end
        end
        return cont
    else
        return dataItems
    end
end

local function DrawLogs()
    g.setForeground(0x73848d)
    for i = 1, #debugLog1 do
        g.set(85, 4 + i, tostring(debugLog1[i]))
    end
    for i = 1, #debugLog2 do
        g.set(85, 26 + i, tostring(debugLog2[i]))
    end
    g.setForeground(CTEXT)
end

local function Main()
    if guiPath[#guiPath] == "start" or guiPath[#guiPath] == "stop" or guiPath[#guiPath] == "go" then
        g.set(13, 5, "Название предмета:")
        g.set(45, 5, "Кол-во:")
        g.set(60, 5, "Крафт:")
        g.set(20,43, "Для поиска введите название..")
        oc.right(71,50, "Всего "..#dataItems.. " крафтов")
        g.fill(85,1, 75, 51, " ")
        DrawLogs()
        DrawScrollContent()
    elseif guiPath[#guiPath] == "change" then
        local sel = posSelect or 1
        g.set(13, 10, "Название предмета: "..(dataItems[sel].name or "?"))
        g.set(13, 12, "id предмета: "..tostring(dataItems[sel].id))
        g.set(13, 14, "dmg предмета: "..tostring(dataItems[sel].dmg))
        g.set(13, 16, "Количество поддержания: "..tostring(dataItems[sel].count))
        g.set(13, 18, "Размер крафта: "..tostring(dataItems[sel].craftSize))
    end
end

-- КНОПКИ
local function DrawButtons()
    for button in pairs(buttons) do
        for i = 1, #buttons[button].ButtonIn do
            if buttons[button].ButtonIn[i] == guiPath[#guiPath] and buttons[button].visible then
                oc.drawbutton(buttons[button].x,buttons[button].y,buttons[button].w, buttons[button].h, buttons[button].ctext, buttons[button].cbutton, buttons[button].text)
            end
        end
    end
end

-- ПРОКРУТКА
local function DrawScrolls()
    for key in pairs(scrolls) do
        for i = 1, #scrolls[key].ScrollIn do
            if scrolls[key].ScrollIn[i] == guiPath[#guiPath] then
                scrolls[key].action()
                oc.drawscroll(scrolls[key].x, scrolls[key].y, scrolls[key].w, scrolls[key].h, scroll, #content, 0x1e1e1e, 0x004575)
                oc.drawbutton(scrolls[key].xGui,scrolls[key].yGui,scrolls[key].wGui,scrolls[key].hGui,CBUTTON,CDRAW,"")
            end
        end
    end
end

local function toGui(gui, clear)
    if clear then
        guiPath[#guiPath] = nil
    end
    if guiPath[#guiPath] ~= gui then
        guiPath[#guiPath + 1] = gui
    end
    dataItems = oc.loadf("BD.txt")
    content = ScrollContent()
    maxscroll = math.max(1, #content - 34)
    Clear()
    Main()
    DrawButtons()
    DrawScrolls()
end

local function Back(to)
    if to then 
        if to <= #guiPath then for i = 1, to do table.remove(guiPath, #guiPath) end end
    else
        table.remove(guiPath, #guiPath)
    end
    posSelect = nil
    Clear()
    Main()
    DrawButtons()
    DrawScrolls()
end

-- ПРОКРУТКА МЫШЬЮ
local function eScroll(_,_,_,_,zs,nick)
    if ADM[nick] then
        for key in pairs(scrolls) do
            for i = 1, #scrolls[key].ScrollIn do
                if scrolls[key].ScrollIn[i] == guiPath[#guiPath] then
                    if not zs then
                        scroll = 1
                    elseif zs == 1 and scroll > 1 then
                        scroll = scroll - 1
                    elseif zs == -1 and scroll < maxscroll then
                        scroll = scroll + 1
                    end
                    content = ScrollContent()
                    Clear()
                    Main()
                    DrawButtons()
                    DrawScrolls()
                end
            end
        end
    end
end

-- ВЫБОР МЫШЬЮ
local function eButton(_,_,x,y,_, nick)
    if ADM[nick] then
        for button in pairs(buttons) do
            if x >= buttons[button].x and x <= buttons[button].endX and y >= buttons[button].y and y <= buttons[button].endY then
                for i = 1, #buttons[button].ButtonIn do
                    if buttons[button].ButtonIn[i] == guiPath[#guiPath] then
                        yTouch = y
                        buttons[button].action()
                        return true
                    end
                end
            end
        end
        -- Выбор строки мышью
        if guiPath[#guiPath] == "start" or guiPath[#guiPath] == "go" or guiPath[#guiPath]=="stop" then
            for i = scroll, math.min(scroll + 34, #content) do
                local k = i - scroll
                if y == 7 + k then
                    posSelect = i
                    Clear()
                    Main()
                    DrawButtons()
                    DrawScrolls()
                    break
                end
            end
        end
    end
end

-- ПОИСК (клавиатура)
local function InputWrite(_,_,key1, key2,nick)
    if ADM[nick] then
        for key in pairs(scrolls) do
            for i = 1, #scrolls[key].ScrollIn do
                if scrolls[key].ScrollIn[i] == guiPath[#guiPath] then
                    local y = scrolls[key].iwY
                    g.fill(20,y, 30, 1, " ")
                    if key1 == 8 then -- backspace
                        inputFind = unicode.sub(inputFind, 1, -2)
                    elseif key1 == 0 and key2 == 211 then -- delete
                        inputFind = ""
                    elseif key1 ~= 0 then -- keyboard
                        if inputFind == nil or inputFind == "" then
                            inputFind = unicode.char(key1)
                        elseif unicode.len(inputFind) < 49 then
                            inputFind = inputFind .. unicode.char(key1)
                        end
                    end
                    content = ScrollContent()
                    Clear()
                    Main()
                    DrawButtons()
                    DrawScrolls()
                end
            end
        end
    end
end

-- КНОПКИ
local function initButtons()
    for button in pairs(buttons) do
        buttons[button].endX = buttons[button].x + buttons[button].w - 1
        buttons[button].endY = buttons[button].y + buttons[button].h - 1
    end
end

-- КНОПКИ КОНФИГ
buttons = {
    Logo = {ButtonIn = {"start", "go", "stop", "change"}, visible = true, x = 10, y = 1, w = 62, h = 3, cbutton = 0x004575, ctext = 0x00ffff, text = "PreCraft", action = function() end},
    Exit = {ButtonIn = {"start", "go", "stop", "change"}, visible = false, x = 1, y = 1, w = 1, h = 1, cbutton = 0x004575, ctext = 0x00ffff, text = "", action = function() g.setResolution(160,50) event.cancel(etouch) event.cancel(ekeydown) event.cancel(escroll) precraft = false end},
    Select = {ButtonIn = {"stop"}, visible = false, x = 11, y = 7, w = 60, h = 35, text = "", action = function() posSelect = yTouch + scroll - 7 DrawScrollContent() end},
    Go = {ButtonIn = {"start","go"}, visible = true, x = 14, y = 47, w = 24, h = 3, cbutton = 0x28C730, ctext = 0x28C730, text = "Go", action = function() end},
    GoTrue = {ButtonIn = {"stop"}, visible = true, x = 14, y = 47, w = 24, h = 3, cbutton = 0x00ffff, ctext = 0x00ffff, text = "Go", action = function() toGui("go") dataq = dataItems go = true end},
    Stop = {ButtonIn = {"stop"}, visible = true, x = 43, y = 47, w = 24, h = 3, cbutton = 0xff0000, ctext = 0xff0000, text = "Stop", action = function() end},
    StopTrue = {ButtonIn = {"start", "go"}, visible = true, x = 43, y = 47, w = 24, h = 3, cbutton = 0x00ffff, ctext = 0x00ffff,text = "Stop", action = function() toGui("stop") go = false end},
    Add = {ButtonIn = {"stop"}, visible = true, x = 20, y = 45, w = 10, h = 1, cbutton = nil, ctext = 0x00ffff, text = "[Добавить]", action = function() AddItem() end},
    Change = {ButtonIn = {"stop"}, visible = true, x = 36, y = 45, w = 10, h = 1, cbutton = nil, ctext = 0x00ffff, text = "[Изменить]", action = function() EditItem() end},
    Remove = {ButtonIn = {"stop"}, visible = true, x = 54, y = 45, w = 9, h = 1, cbutton = nil, ctext = 0x00ffff, text = "[Удалить]", action = function() RemoveItem() end},
    changeName = {ButtonIn = {"change"}, visible = true, x = 14, y = 35, w = 53, h = 3, cbutton = 0x004575, ctext = 0x00ffff, text = "Изменить название", action = function() ChangeItem("changeName") end},
    changeCount = {ButtonIn = {"change"}, visible = true, x = 14, y = 38, w = 53, h = 3, cbutton = 0x004575, ctext = 0x00ffff, text = "Изменить количество поддержания", action = function() ChangeItem("changeCount") end},
    changeCraftSize = {ButtonIn = {"change"}, visible = true, x = 14, y = 41, w = 53, h = 3, cbutton = 0x004575, ctext = 0x00ffff, text = "Изменит размер крафта", action = function() ChangeItem("changeCraftSize") end},
    changeBack = {ButtonIn = {"change"}, visible = true, x = 14, y = 47, w = 53, h = 3, cbutton = 0x004575, ctext = 0x00ffff, text = "Назад", action = function() Back() end},
}

-- ПРОКРУТКА КОНФИГ
scrolls = {
    Buy = {ScrollIn = {"start", "go", "stop"},iwY = 43, xGui = 10 , yGui = 6, wGui = 62, hGui = 37, x = 70, y = 7, w = 1, h = 35, action = function() content = ScrollContent() end},
}

-- ОСНОВНОЙ ЦИКЛ
function loop()
    dataItems = oc.loadf("BD.txt")
    initButtons()
    etouch = event.listen("touch", eButton)
    escroll = event.listen("scroll", eScroll)
    ekeydown = event.listen("key_down", InputWrite)
    toGui("start")
    while precraft do
        os.sleep(0.05)
    end
end

local ok, err = pcall(loop)
if not ok then
    event.cancel(etouch)
    event.cancel(escroll)
    event.cancel(ekeydown)
    print("Ошибка: " .. tostring(err))
end
