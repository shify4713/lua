local component = require("component")
local fs = require("filesystem")
local shell = require("shell")
local event = require("event")
local unicode = require("unicode")
local term = require("term")
local computer = require("computer")
local g = component.gpu
local me = component.me_interface
local serialization = require("serialization")

-- Пути и библиотека
local DATA_FILE = "/home/BD.txt"
local LIB_PATH = "/lib/ultimateOC.lua"
local LIB_URL = "https://raw.githubusercontent.com/shify4713/lua/refs/heads/main/ultimateOC.lua"

-- Проверка доступности компонентов
local function checkComponents()
    if not component.isAvailable("gpu") then
        io.stderr:write("Ошибка: GPU недоступен\n")
        os.exit(1)
    end
    if not component.isAvailable("screen") then
        io.stderr:write("Ошибка: Экран недоступен\n")
        os.exit(1)
    end
    if not component.isAvailable("me_interface") then
        io.stderr:write("Ошибка: ME-интерфейс недоступен\n")
        os.exit(1)
    end
end

-- Привязка GPU к экрану
local function bindGpu()
    local screen = component.list("screen")()
    if not screen then
        io.stderr:write("Ошибка: Не найден экран для привязки GPU\n")
        os.exit(1)
    end
    local success, err = pcall(g.bind, screen)
    if not success then
        io.stderr:write("Ошибка при привязке GPU к экрану: " .. tostring(err) .. "\n")
        os.exit(1)
    end
end

-- Загрузка или скачивание библиотеки
local function loadLibrary()
    if not fs.exists(LIB_PATH) then
        addLog(logs, "INFO: Библиотека " .. LIB_PATH .. " не найдена, скачивание...", "INFO")
        local ok, err = shell.execute("wget " .. LIB_URL .. " " .. LIB_PATH)
        if not ok then
            addLog(logs, "ERROR: Не удалось скачать библиотеку: " .. tostring(err), "ERROR")
            return nil
        end
        addLog(logs, "INFO: Библиотека успешно скачана.", "INFO")
    end
    local ok, M = pcall(require, string.sub(LIB_PATH, 2)) -- Убираем / в начале для require
    if not ok then
        addLog(logs, "ERROR: Ошибка при загрузке библиотеки: " .. tostring(M), "ERROR")
        return nil
    end
    return M
end

-- Глобальные переменные
local WIDTH, HEIGHT
local M
local craftItems = {} -- Список предметов для крафта
local meItems = {} -- Список предметов в ME-системе
local logs = {} -- Логи
local currentTab = "main" -- Текущая активная вкладка: "main", "settings", "add", "logs"
local selectedItem = nil -- Выбранный предмет в списке (для редактирования/удаления)
local currentPage = 1 -- Текущая страница в списке предметов
local itemsPerPage = 15 -- Количество предметов на одной странице
local logOffset = 0 -- Смещение для прокрутки логов
local inputBuffer = "" -- Буфер для ввода текста (название предмета)
local isAddingItem = false -- Флаг, активен ли режим добавления предмета
local currentSearchTerm = "" -- Строка поиска для фильтрации предметов


-- Вспомогательная функция для добавления логов (из lib-gemeni.txt)
local function addLog(logs_tbl, text, lvl)
    lvl = lvl or "INFO"
    local now = os.date("!*t", os.time()+3*3600) -- МСК
    local t = string.format("[%02d:%02d:%02d][%s] %s", now.hour, now.min, now.sec, lvl, text)
    table.insert(logs_tbl, t)
    while #logs_tbl > 50 do table.remove(logs_tbl, 1) end
end

-- Загрузка данных
local function loadData()
    if fs.exists(DATA_FILE) then
        local success, data = pcall(M.loadf, DATA_FILE)
        if success then
            craftItems = data
            addLog(logs, "Данные успешно загружены из " .. DATA_FILE, "INFO")
        else
            addLog(logs, "ERROR: Ошибка при загрузке данных: " .. tostring(data), "ERROR")
            craftItems = {}
        end
    else
        addLog(logs, "INFO: Файл данных " .. DATA_FILE .. " не найден. Создан пустой список.", "INFO")
        craftItems = {}
    end
end

-- Сохранение данных
local function saveData()
    local success, err = pcall(M.savef, DATA_FILE, craftItems)
    if not success then
        addLog(logs, "ERROR: Ошибка при сохранении данных: " .. tostring(err), "ERROR")
    else
        addLog(logs, "Данные успешно сохранены в " .. DATA_FILE, "INFO")
    end
end

-- Обновление списка предметов в ME-системе
local function updateMEItems()
    local success, items = pcall(me.getItemsInNetwork)
    if success then
        meItems = items
        addLog(logs, "Список предметов ME обновлен. Всего: " .. #meItems, "INFO")
    else
        addLog(logs, "ERROR: Не удалось получить список предметов из ME-ининтерфейса: " .. tostring(items), "ERROR")
        meItems = {}
    end
end

-- Функция для добавления предмета в базу данных
local function addItemToDB(itemName)
    local exists = false
    for _, item in ipairs(craftItems) do
        if item.name == itemName then
            exists = true
            break
        end
    end

    if not exists then
        local newItem = {
            name = itemName,
            count = 1, -- Дефолтное количество
            craftSize = 1, -- Дефолтный размер крафта
            minCount = 1, -- Дефолтное минимальное количество
        }
        table.insert(craftItems, newItem)
        saveData() -- Сохраняем после добавления
        addLog(logs, "Предмет '" .. itemName .. "' успешно добавлен.", "INFO")
        -- После добавления предмета, можно переключиться на другую вкладку или остаться на текущей
        -- currentTab = "main" -- Например, переключиться на главную вкладку
    else
        addLog(logs, "Предмет '" .. itemName .. "' уже существует.", "WARN")
    end
end


-- Функция для удаления предмета
local function deleteItem(index)
    if index and craftItems[index] then
        local itemName = craftItems[index].name
        table.remove(craftItems, index)
        saveData()
        addLog(logs, "Предмет '" .. itemName .. "' удален.", "INFO")
        selectedItem = nil -- Сбрасываем выбранный предмет
        -- Проверяем, не вышла ли текущая страница за границы
        local maxPages = math.max(1, math.ceil(#craftItems / itemsPerPage))
        if currentPage > maxPages then
            currentPage = maxPages
        end
    else
        addLog(logs, "ERROR: Не удалось удалить предмет. Неверный индекс.", "ERROR")
    end
end

-- Функция для изменения значения (универсальная)
local function changeItemValue(index, field, newValue)
    if index and craftItems[index] then
        craftItems[index][field] = newValue
        saveData()
        addLog(logs, "Изменено: " .. craftItems[index].name .. " -> " .. field .. " = " .. tostring(newValue), "INFO")
    else
        addLog(logs, "ERROR: Не удалось изменить предмет. Неверный индекс.", "ERROR")
    end
end

-- Основная функция отрисовки GUI
local function draw()
    g.setBackground(0x282A36) -- Фоновый цвет Dracula
    g.setForeground(0xF8F8F2) -- Цвет текста Dracula
    g.setResolution(WIDTH, HEIGHT)
    g.fill(1, 1, WIDTH, HEIGHT, " ") -- Очистка экрана

    -- Заголовок программы
    M.drawBox(1, 1, WIDTH, 2, "Auto-Gemeni", 0xBD93F9)

    -- Вкладки
    M.drawButton(2, 2, "[Главная]", function()
        currentTab = "main"
        selectedItem = nil
        inputBuffer = "" -- Очищаем буфер при смене вкладки
        isAddingItem = false
        currentSearchTerm = ""
    end, currentTab == "main")
    M.drawButton(12, 2, "[Настройки]", function()
        currentTab = "settings"
        selectedItem = nil
        inputBuffer = ""
        isAddingItem = false
        currentSearchTerm = ""
    end, currentTab == "settings")
    M.drawButton(25, 2, "[Добавить]", function()
        currentTab = "add"
        selectedItem = nil
        inputBuffer = "" -- Очищаем буфер при смене вкладки
        isAddingItem = true -- Активируем режим ввода при переходе
        currentSearchTerm = ""
    end, currentTab == "add")
    M.drawButton(36, 2, "[Логи]", function()
        currentTab = "logs"
        selectedItem = nil
        inputBuffer = ""
        isAddingItem = false
        currentSearchTerm = ""
    end, currentTab == "logs")


    -- Содержимое вкладок
    if currentTab == "main" then
        M.drawBox(1, 1, WIDTH, HEIGHT, "Список предметов", 0x8BE9FD)

        -- Поле поиска
        g.setForeground(0xFFFFFF)
        g.setBackground(0x282A36)
        g.set(3, 3, "Поиск: " .. currentSearchTerm .. string.rep(" ", math.max(0, WIDTH - 10 - unicode.len(currentSearchTerm))))

        -- Отображение списка предметов
        local filteredItems = M.filterItems(craftItems, currentSearchTerm)
        local startIndex = (currentPage - 1) * itemsPerPage + 1
        local endIndex = math.min(startIndex + itemsPerPage - 1, #filteredItems)

        if #filteredItems == 0 and currentSearchTerm ~= "" then
            g.setForeground(0x8BE9FD)
            g.set(3, 6, "Ничего не найдено по запросу: '" .. currentSearchTerm .. "'")
        elseif #filteredItems == 0 then
            g.setForeground(0x8BE9FD)
            g.set(3, 6, "Список предметов пуст. Добавьте предметы во вкладке 'Добавить'.")
        else
            for i = startIndex, endIndex do
                local item = filteredItems[i]
                local displayIndex = i - startIndex + 1
                local yPos = 5 + displayIndex

                local textColor = 0xFFFFFF
                if selectedItem and selectedItem.name == item.name then
                    textColor = 0x50FA7B -- Цвет выбранного элемента
                end

                g.setForeground(textColor)
                g.set(3, yPos, string.format("%d. %s (ME: %d, Мин: %d, Крафт: %d)", i, item.name, item.count, item.minCount, item.craftSize))
            end
        end

        -- Навигация по страницам
        local maxPages = math.max(1, math.ceil(#filteredItems / itemsPerPage))
        if maxPages > 1 then
            M.drawButton(WIDTH - 15, HEIGHT - 3, "<", function()
                if currentPage > 1 then
                    currentPage = currentPage - 1
                    selectedItem = nil
                end
            end, M.buttonHover == WIDTH - 15 and M.buttonHoverY == HEIGHT - 3)
            g.setForeground(0xFFFFFF)
            g.set(WIDTH - 12, HEIGHT - 3, string.format("%d/%d", currentPage, maxPages))
            M.drawButton(WIDTH - 8, HEIGHT - 3, ">", function()
                if currentPage < maxPages then
                    currentPage = currentPage + 1
                    selectedItem = nil
                end
            end, M.buttonHover == WIDTH - 8 and M.buttonHoverY == HEIGHT - 3)
        end

        -- Кнопки действий
        if selectedItem then
            M.drawButton(3, HEIGHT - 5, "[Удалить]", function()
                if selectedItem then
                    local index = -1
                    for i, item in ipairs(craftItems) do
                        if item.name == selectedItem.name then
                            index = i
                            break
                        end
                    end
                    if index ~= -1 then
                        deleteItem(index)
                    end
                end
            end, M.buttonHover == 3 and M.buttonHoverY == HEIGHT - 5)
            M.drawButton(15, HEIGHT - 5, "[Изменить]", function()
                -- Здесь можно открыть под-интерфейс для изменения
                addLog(logs, "Функция 'Изменить' пока не реализована.", "INFO")
            end, M.buttonHover == 15 and M.buttonHoverY == HEIGHT - 5)
        end

    elseif currentTab == "settings" then
        M.drawBox(1, 1, WIDTH, HEIGHT, "Настройки", 0x8BE9FD)
        g.setForeground(0xFFFFFF)
        g.set(3, 4, "Здесь будут настройки программы.")
        g.set(3, 6, "Например, интервал автокрафта, параметры логирования.")
    elseif currentTab == "add" then
        M.drawBox(1, 1, WIDTH, HEIGHT, "Добавить предмет", 0x8BE9FD)

        g.setForeground(0xFFFFFF)
        g.setBackground(0x282A36)

        -- Инструкции для пользователя
        g.set(3, 3, "Введите название предмета:")
        g.set(3, 4, "(Нажмите Enter для добавления, Backspace для удаления)")

        -- Отображение текущего ввода
        g.set(3, 6, "Ввод: ")
        local inputX = 3 + unicode.len("Ввод: ")
        local maxInputWidth = WIDTH - inputX - 1 -- Оставляем небольшой отступ справа

        g.setBackground(0x6272A4) -- Цвет фона для поля ввода
        g.set(inputX, 6, unicode.sub(inputBuffer, 1, maxInputWidth) .. string.rep(" ", math.max(0, maxInputWidth - unicode.len(inputBuffer))))
        g.setBackground(0x282A36) -- Возвращаем основной фон

        -- Кнопка "Добавить"
        M.drawButton(3, 8, "[Добавить]", function()
            if inputBuffer ~= "" then
                addItemToDB(inputBuffer)
                inputBuffer = "" -- Очищаем буфер после добавления
                isAddingItem = false -- Выключаем режим ввода после добавления
            else
                addLog(logs, "ERROR: Название предмета не может быть пустым.", "WARN")
            end
        end, M.buttonHover == 3 and M.buttonHoverY == 8)

        -- Кнопка "Отмена"
        M.drawButton(3, 10, "[Отмена]", function()
            inputBuffer = ""
            isAddingItem = false -- Отмена ввода
        end, M.buttonHover == 3 and M.buttonHoverY == 10)

    elseif currentTab == "logs" then
        M.drawBox(1, 1, WIDTH, HEIGHT, "Логи", 0x8BE9FD)
        M.drawLogs(3, 4, logs, math.min(HEIGHT - 6, #logs), 0xFFFFFF) -- Отрисовка логов
    end

    -- Нижний бар для ошибок/информации (отображение последней записи лога)
    M.drawBox(1, HEIGHT - 2, WIDTH, 2, "", 0x6272A4)
    if #logs > 0 then
        g.setForeground(0xFFFFFF)
        g.set(2, HEIGHT - 1, logs[#logs])
    end
end

-- Цикл автокрафта (заглушка)
local function autoCraftLoop()
    while true do
        updateMEItems() -- Обновляем предметы в ME
        -- Здесь будет логика проверки ME-интерфейса и инициирования крафтов
        -- На данный момент, просто логируем для отладки
        addLog(logs, "INFO: Проверка ME-интерфейса и статуса крафтов...", "INFO")

        -- Пример: Проверка первого предмета в списке
        if #craftItems > 0 then
            local itemToCraft = craftItems[1]
            local meItemCount = 0
            for _, meItem in ipairs(meItems) do
                if meItem.label == itemToCraft.name then
                    meItemCount = meItem.size
                    break
                end
            end

            if meItemCount < itemToCraft.minCount then
                local needed = itemToCraft.minCount - meItemCount
                addLog(logs, "WARN: Нужно скрафтить " .. needed .. " " .. itemToCraft.name, "WARN")
                -- Здесь будет вызов me.craft(itemToCraft.name, needed)
            else
                addLog(logs, "INFO: " .. itemToCraft.name .. " (в ME: " .. meItemCount .. ") достаточно.", "INFO")
            end
        else
            addLog(logs, "INFO: Список предметов для крафта пуст.", "INFO")
        end

        os.sleep(10) -- Интервал проверки, можно вынести в настройки
    end
end

-------------------- Инициализация и главный цикл --------------------
addLog(logs, "INFO: Запуск программы...", "INFO")
checkComponents()
bindGpu()
WIDTH, HEIGHT = g.getResolution()
g.setResolution(WIDTH, HEIGHT)

M = loadLibrary() -- Загружаем библиотеку
if not M then
    addLog(logs, "FATAL: Не удалось загрузить библиотеку. Завершение работы.", "ERROR")
    draw()
    while true do os.sleep(1) end
end

addLog(logs, "INFO: Программа запущена", "INFO")
loadData()
updateMEItems()

local reload = function()
    -- Перезагрузка данных и ME-предметов при необходимости
    loadData()
    updateMEItems()
end

-- Основной цикл обработки событий
event.listen("interrupted", computer.shutdown)
event.listen("terminate", computer.shutdown)

event.pull = event.pull or event.pullRaw
while true do
    local e, a, b, c, d, ee = event.pull(0.1) -- Таймаут для обновления экрана

    if e == "touch" then
        local x, y = a, b
        local success, msg = pcall(function()
            -- Обработка кликов по кнопкам вкладок
            if y == 2 then -- Ряд вкладок
                if x >= 2 and x <= 2 + unicode.len("[Главная]") - 1 then currentTab = "main"; selectedItem = nil; inputBuffer = ""; isAddingItem = false; currentSearchTerm = ""
                elseif x >= 12 and x <= 12 + unicode.len("[Настройки]") - 1 then currentTab = "settings"; selectedItem = nil; inputBuffer = ""; isAddingItem = false; currentSearchTerm = ""
                elseif x >= 25 and x <= 25 + unicode.len("[Добавить]") - 1 then currentTab = "add"; selectedItem = nil; inputBuffer = ""; isAddingItem = true; currentSearchTerm = ""
                elseif x >= 36 and x <= 36 + unicode.len("[Логи]") - 1 then currentTab = "logs"; selectedItem = nil; inputBuffer = ""; isAddingItem = false; currentSearchTerm = ""
                end
            end

            -- Обработка кликов внутри вкладок
            if currentTab == "main" then
                -- Клик по элементу списка
                local filteredItems = M.filterItems(craftItems, currentSearchTerm)
                local startIndex = (currentPage - 1) * itemsPerPage + 1
                for i = startIndex, math.min(startIndex + itemsPerPage - 1, #filteredItems) do
                    local displayIndex = i - startIndex + 1
                    local yPos = 5 + displayIndex
                    if y == yPos then
                        selectedItem = filteredItems[i]
                        addLog(logs, "Выбран предмет: " .. selectedItem.name, "INFO")
                        break
                    end
                end

                -- Обработка кнопок действий в главной вкладке
                if y == HEIGHT - 5 then
                    if x >= 3 and x <= 3 + unicode.len("[Удалить]") - 1 then
                        if selectedItem then
                            local index = -1
                            for i, item in ipairs(craftItems) do
                                if item.name == selectedItem.name then
                                    index = i
                                    break
                                end
                            end
                            if index ~= -1 then
                                deleteItem(index)
                            end
                        end
                    elseif x >= 15 and x <= 15 + unicode.len("[Изменить]") - 1 then
                        addLog(logs, "Функция 'Изменить' пока не реализована.", "INFO")
                    end
                end

                -- Обработка кнопок пагинации
                if y == HEIGHT - 3 then
                    local maxPages = math.max(1, math.ceil(#filteredItems / itemsPerPage))
                    if maxPages > 1 then
                        if x >= WIDTH - 15 and x <= WIDTH - 15 + unicode.len("<") - 1 then
                            if currentPage > 1 then
                                currentPage = currentPage - 1
                                selectedItem = nil
                            end
                        elseif x >= WIDTH - 8 and x <= WIDTH - 8 + unicode.len(">") - 1 then
                            if currentPage < maxPages then
                                currentPage = currentPage + 1
                                selectedItem = nil
                            end
                        end
                    end
                end

            elseif currentTab == "add" then
                -- Обработка кнопки "Добавить"
                if y == 8 and x >= 3 and x <= 3 + unicode.len("[Добавить]") - 1 then
                    if inputBuffer ~= "" then
                        addItemToDB(inputBuffer)
                        inputBuffer = ""
                        isAddingItem = false
                    else
                        addLog(logs, "ERROR: Название предмета не может быть пустым.", "WARN")
                    end
                -- Обработка кнопки "Отмена"
                elseif y == 10 and x >= 3 and x <= 3 + unicode.len("[Отмена]") - 1 then
                    inputBuffer = ""
                    isAddingItem = false
                end
            end
        end)
        if not success then
            addLog(logs, "ERROR: Ошибка обработки клика: " .. tostring(msg), "ERROR")
        end
    elseif e == "key" then
        local key = a
        local unicodeChar = unicode.char(key) -- Получаем символ из кода клавиши
        local arg = b -- Аргументы события (например, Shift)

        if currentTab == "main" then
            if key == 14 then -- Backspace для поиска
                currentSearchTerm = unicode.sub(currentSearchTerm, 1, unicode.len(currentSearchTerm) - 1)
                currentPage = 1 -- Сброс страницы при изменении поиска
                selectedItem = nil
            elseif unicodeChar ~= nil and unicodeChar ~= "" and key ~= 28 then -- Любой другой вводимый символ, кроме Enter
                if unicode.len(currentSearchTerm) < (WIDTH - 10) then -- Ограничение длины поиска
                    currentSearchTerm = currentSearchTerm .. unicodeChar
                end
                currentPage = 1
                selectedItem = nil
            end
        elseif currentTab == "add" then
            if key == 28 then -- Enter
                if inputBuffer ~= "" then
                    addItemToDB(inputBuffer)
                    inputBuffer = "" -- Очищаем буфер после добавления
                    isAddingItem = false -- Выключаем режим ввода
                else
                    addLog(logs, "ERROR: Название предмета не может быть пустым.", "WARN")
                end
            elseif key == 14 then -- Backspace
                inputBuffer = unicode.sub(inputBuffer, 1, unicode.len(inputBuffer) - 1)
            elseif unicodeChar ~= nil and unicodeChar ~= "" then -- Любой другой вводимый символ
                -- Добавляем только печатные символы и ограничиваем длину
                local maxInputWidth = WIDTH - (3 + unicode.len("Ввод: ")) - 1
                if unicode.len(inputBuffer) < maxInputWidth then -- Ограничение длины ввода
                    inputBuffer = inputBuffer .. unicodeChar
                end
            end
        elseif currentTab == "logs" then
            if key == 200 and arg.shift then -- Shift + Up для логов (прокрутка вверх)
                logOffset = math.min(logOffset + 1, math.max(0, #logs - (HEIGHT - 6)))
            elseif key == 208 and arg.shift then -- Shift + Down для логов (прокрутка вниз)
                logOffset = math.max(logOffset - 1, 0)
            end
        end
    end
    -- Обновляем состояние наведения кнопок
    local mx, my = term.getCursor()
    M.buttonHover = nil
    M.buttonHoverY = nil

    -- Проверка наведения на кнопки вкладок
    if my == 2 then
        if mx >= 2 and mx <= 2 + unicode.len("[Главная]") - 1 then M.buttonHover, M.buttonHoverY = 2, 2
        elseif mx >= 12 and mx <= 12 + unicode.len("[Настройки]") - 1 then M.buttonHover, M.buttonHoverY = 12, 2
        elseif mx >= 25 and mx <= 25 + unicode.len("[Добавить]") - 1 then M.buttonHover, M.buttonHoverY = 25, 2
        elseif mx >= 36 and mx <= 36 + unicode.len("[Логи]") - 1 then M.buttonHover, M.buttonHoverY = 36, 2
        end
    end

    -- Проверка наведения на кнопки внутри вкладок
    if currentTab == "main" then
        if my == HEIGHT - 5 then
            if mx >= 3 and mx <= 3 + unicode.len("[Удалить]") - 1 then M.buttonHover, M.buttonHoverY = 3, HEIGHT - 5
            elseif mx >= 15 and mx <= 15 + unicode.len("[Изменить]") - 1 then M.buttonHover, M.buttonHoverY = 15, HEIGHT - 5
            end
        elseif my == HEIGHT - 3 then
            if mx >= WIDTH - 15 and mx <= WIDTH - 15 + unicode.len("<") - 1 then M.buttonHover, M.buttonHoverY = WIDTH - 15, HEIGHT - 3
            elseif mx >= WIDTH - 8 and mx <= WIDTH - 8 + unicode.len(">") - 1 then M.buttonHover, M.buttonHoverY = WIDTH - 8, HEIGHT - 3
            end
        end
    elseif currentTab == "add" then
        if my == 8 then
            if mx >= 3 and mx <= 3 + unicode.len("[Добавить]") - 1 then M.buttonHover, M.buttonHoverY = 3, 8 end
        elseif my == 10 then
            if mx >= 3 and mx <= 3 + unicode.len("[Отмена]") - 1 then M.buttonHover, M.buttonHoverY = 3, 10 end
        end
    end

    draw()
end

local ok, err = pcall(autoCraftLoop)
if not ok then
    addLog(logs, "ERROR: Фатальная ошибка в autoCraftLoop: " .. tostring(err), "ERROR")
    draw()
    while true do os.sleep(1) end
end
